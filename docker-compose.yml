# docker-compose.yml (Versión Corregida)
version: '3.8'

services:
  # 1. El Frontend
  frontend:
    build: ./ecopoints-frontend
    ports:
      - "5173:80"
    
  # 2. El Publicador
  publicador:
    build: ./servicio-publicador-demo
    ports:
      - "3006:3006"
    # CAMBIO IMPORTANTE: Espera a que RabbitMQ esté saludable
    depends_on:
      rabbitmq:
        condition: service_healthy

  # 3. El Consumidor (Tu Servicio)
  estadisticas:
    build: ./servicio-estadisticas
    ports:
      - "3005:3005"
    # CAMBIO IMPORTANTE: Espera a que RabbitMQ esté saludable
    depends_on:
      rabbitmq:
        condition: service_healthy

  # 4. El Mensajero
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    # NUEVA SECCIÓN: Esta prueba verifica que RabbitMQ esté listo
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5